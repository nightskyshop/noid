<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{{ url_for('static',
    filename="./styles/vars.css") }}"> <link rel="stylesheet" href="{{
    url_for('static', filename="./styles/take_photo-2.css") }}">

    <style>
      @font-face {
        font-family: "Pretendard-Bold";
        font-style: normal;
        src: url("{{ url_for('static', filename='./fonts/Pretendard-Bold.otf') }}")
          format("opentype");
        font-display: swap;
      }

      @font-face {
        font-family: "Pretendard-Thin";
        font-style: normal;
        src: url("{{ url_for('static', filename='./fonts/Pretendard-Thin.otf') }}")
          format("opentype");
        font-display: swap;
      }

      @font-face {
        font-family: "Pretendard-Light";
        font-style: normal;
        src: url("{{ url_for('static', filename='./fonts/Pretendard-Light.otf') }}")
          format("opentype");
        font-display: swap;
      }

      @font-face {
        font-family: "Pretendard-SemiBold";
        font-style: normal;
        src: url("{{ url_for('static', filename='./fonts/Pretendard-SemiBold.otf') }}")
          format("opentype");
        font-display: swap;
      }

      a,
      button,
      input,
      select,
      h1,
      h2,
      h3,
      h4,
      h5,
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        border: none;
        text-decoration: none;
        background: none;
        -webkit-font-smoothing: antialiased;
      }

      menu,
      ol,
      ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      .photo-view {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        width: 400px;
        height: 520px; /* ì›í•˜ëŠ” ë†’ì´ ì¡°ì ˆ */
        margin-top: 10px;
      }

      video {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      .counter {
        text-align: center;
        font-size: 24px;
        margin-bottom: 10px;
        color: #000;
      }

      /* p-1 ~ p-6 ìŠ¤íƒ€ì¼ ë¯¸ë¦¬ë³´ê¸°ìš© */
      .p-1,
      .p-2,
      .p-3,
      .p-4,
      .p-5,
      .p-6 {
        width: 120px;
        height: 90px;
        margin: 5px;
        border: 2px solid #ccc;
        display: inline-block;
        vertical-align: top;
        background: #eee;
        overflow: hidden;
      }

      .p-1 img,
      .p-2 img,
      .p-3 img,
      .p-4 img,
      .p-5 img,
      .p-6 img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
    </style>

    <title>ì´¬ì˜ ì¤‘...</title>
  </head>
  <body>
    <div class="_2">
      <div class="counter" id="counter">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</div>

      <div class="photo-view">
        <video id="video" autoplay width="500" height="650"></video>
      </div>

      <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ -->
      <div class="container">
        <div class="p-1"></div>
        <div class="p-2"></div>
        <div class="p-3"></div>
        <div class="p-4"></div>
        <div class="p-5"></div>
        <div class="p-6"></div>
      </div>

      <div class="rectangle-8"></div>
      <div class="div2" onclick="location.href='take_select_photo'">
        ê³„ì†í•˜ê¸° â†’
      </div>
    </div>

    <!-- ê¸°ì¡´ ì½”ë“œ ì¤‘ script ë¶€ë¶„ë§Œ ìˆ˜ì • ì˜ˆì‹œ -->
    <script>
      const video = document.getElementById("video");
      const counter = document.getElementById("counter");
      const photoDivs = [
        document.querySelector(".p-1"),
        document.querySelector(".p-2"),
        document.querySelector(".p-3"),
        document.querySelector(".p-4"),
        document.querySelector(".p-5"),
        document.querySelector(".p-6"),
      ];

      let photosTaken = 0;
      let capturedPhotos = []; // ì—¬ê¸°ì„œ ì‚¬ì§„ ì €ì¥

      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
        })
        .catch((err) => {
          console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:", err);
          counter.innerText = "ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨";
        });

      function takePhoto() {
        if (photosTaken >= 6) {
          counter.innerText = "ì´¬ì˜ ì™„ë£Œ! ì €ì¥ ì¤‘...";
          // ì´¬ì˜ì´ ëë‚˜ë©´ localStorageì— ì €ì¥
          localStorage.setItem(
            "capturedPhotos",
            JSON.stringify(capturedPhotos)
          );
          return;
        }

        const canvas = document.createElement('canvas');
        const targetRatio = 10/13;

        let canvasWidth, canvasHeight;
        if (video.videoWidth / video.videoHeight > targetRatio) {
            // ë¹„ë””ì˜¤ê°€ ë” ë„“ì€ ê²½ìš°
            canvasHeight = video.videoHeight;
            canvasWidth = canvasHeight * targetRatio;
        } else {
            // ë¹„ë””ì˜¤ê°€ ë” ì¢ì€ ê²½ìš°
            canvasWidth = video.videoWidth;
            canvasHeight = canvasWidth / targetRatio;
        }

        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        const ctx = canvas.getContext('2d');

        const sourceX = (video.videoWidth - canvasWidth) / 2;
        const sourceY = (video.videoHeight - canvasHeight) / 2;

        // ì¢Œìš°ë°˜ì „
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);

        ctx.drawImage(
            video,
            sourceX, sourceY,          // ì›ë³¸ ì´ë¯¸ì§€ì—ì„œ ìë¥¼ ì‹œì‘ì  (ì¤‘ì•™)
            canvasWidth, canvasHeight, // ì›ë³¸ ì´ë¯¸ì§€ì—ì„œ ìë¥¼ í¬ê¸°
            0, 0,                      // ìº”ë²„ìŠ¤ì— ê·¸ë¦´ ì‹œì‘ì 
            canvasWidth, canvasHeight, // ìº”ë²„ìŠ¤ì— ê·¸ë¦´ í¬ê¸°
        );

        const dataURL = canvas.toDataURL("image/png");
        capturedPhotos.push(dataURL); // ì‚¬ì§„ ì €ì¥

        const img = document.createElement("img");
        img.src = dataURL;
        photoDivs[photosTaken].innerHTML = "";
        photoDivs[photosTaken].appendChild(img);

        photosTaken++;

        if (photosTaken < 6) {
          counter.innerText = `ğŸ“¸ ${photosTaken + 1}ë²ˆì§¸ ì´¬ì˜ ì¤€ë¹„ ì¤‘...`;
          setTimeout(() => {
            counter.innerText = `ğŸ“¸ ${photosTaken}ë²ˆì§¸ ì´¬ì˜ ì¤‘...`;
            takePhoto();
          }, 4000);
        } else {
          counter.innerText = "ì´¬ì˜ ì™„ë£Œ! ì €ì¥ ì¤‘...";
          // ì—¬ê¸°ì„œë„ ì €ì¥ í•œë²ˆ ë” ì•ˆì „í•˜ê²Œ
          localStorage.setItem(
            "capturedPhotos",
            JSON.stringify(capturedPhotos)
          );
        }
      }

      // 5ì´ˆ ëŒ€ê¸° í›„ ì´¬ì˜ ì‹œì‘
      setTimeout(() => {
        counter.innerText = "ğŸ“¸ ì²« ë²ˆì§¸ ì´¬ì˜ ì¤‘...";

        const formData = new FormData();
        formData.append("frame", "{{request.args.get("frame")}}");

        fetch("/api/session", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨");
            return response.json();
          })
          .then((data) => {
            console.log("ì„œë²„ ì‘ë‹µ:", data);
            localStorage.setItem("session", data.sessionID);
          })
          .catch((error) => {
            console.log("formData: ", formData.get("session"));
            console.error("ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
            alert("session ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ.");
          });

        takePhoto();
      }, 5000);
    </script>
  </body>
</html>
