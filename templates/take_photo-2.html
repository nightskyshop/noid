<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='./styles/vars.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='./styles/take_photo-2.css') }}"
    />

    <style>
      @font-face {
        font-family: "Pretendard-Bold";
        src: url("{{ url_for('static', filename='./fonts/Pretendard-Bold.otf') }}")
          format("opentype");
        font-display: swap;
      }

      @font-face {
        font-family: "Pretendard-Thin";
        src: url("{{ url_for('static', filename='./fonts/Pretendard-Thin.otf') }}")
          format("opentype");
        font-display: swap;
      }

      @font-face {
        font-family: "Pretendard-Light";
        src: url("{{ url_for('static', filename='./fonts/Pretendard-Light.otf') }}")
          format("opentype");
        font-display: swap;
      }

      @font-face {
        font-family: "Pretendard-SemiBold";
        src: url("{{ url_for('static', filename='./fonts/Pretendard-SemiBold.otf') }}")
          format("opentype");
        font-display: swap;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        border: none;
        text-decoration: none;
        background: none;
        -webkit-font-smoothing: antialiased;
      }

      menu,
      ol,
      ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      .photo-view {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        width: 400px;
        height: 520px;
        margin-top: 10px;
      }

      video {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      .counter {
        text-align: center;
        font-size: 24px;
        margin-bottom: 10px;
        color: #000;
      }

      .p-1,
      .p-2,
      .p-3,
      .p-4,
      .p-5,
      .p-6 {
        width: 120px;
        height: 90px;
        margin: 5px;
        border: 2px solid #ccc;
        display: inline-block;
        background: #eee;
        overflow: hidden;
      }

      .p-1 img,
      .p-2 img,
      .p-3 img,
      .p-4 img,
      .p-5 img,
      .p-6 img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      #flash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        opacity: 0;
        z-index: 9999;
        pointer-events: none;
        transition: opacity 0.1s;
      }

      #continue-btn {
        pointer-events: none;
        opacity: 0.5;
      }

      #continue-btn.active {
        pointer-events: auto;
        opacity: 1;
      }
    </style>

    <title>Ï¥¨ÏòÅ Ï§ë...</title>
  </head>
  <body>
    <div class="_2">
      <div id="flash"></div>
      <div class="counter" id="counter">Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî...</div>

      <div class="photo-view">
        <video id="video" autoplay width="500" height="650"></video>
      </div>

      <div class="container">
        <div class="p-1"></div>
        <div class="p-2"></div>
        <div class="p-3"></div>
        <div class="p-4"></div>
        <div class="p-5"></div>
        <div class="p-6"></div>
      </div>

      <div class="rectangle-8"></div>
      <div
        class="div2"
        id="continue-btn"
        onclick="location.href='take_select_photo'"
      >
        Í≥ÑÏÜçÌïòÍ∏∞ ‚Üí
      </div>
    </div>

    <script>
      const video = document.getElementById("video");
      const counter = document.getElementById("counter");
      const photoDivs = [
        document.querySelector(".p-1"),
        document.querySelector(".p-2"),
        document.querySelector(".p-3"),
        document.querySelector(".p-4"),
        document.querySelector(".p-5"),
        document.querySelector(".p-6"),
      ];

      let photosTaken = 0;
      let capturedPhotos = [];
      const continueBtn = document.getElementById("continue-btn");

      // ÌîåÎûòÏãú Ìö®Í≥º
      function flashEffect() {
        const flash = document.getElementById("flash");
        flash.style.opacity = "1";
        setTimeout(() => {
          flash.style.opacity = "0";
        }, 100);
      }

      // Ïã§ÏãúÍ∞Ñ Ïπ¥Ïö¥Ìä∏Îã§Ïö¥
      function startCountdown(seconds, onFinish) {
        let remaining = seconds;
        counter.innerText = `üì∏ ${photosTaken + 1}Î≤àÏß∏ Ï¥¨ÏòÅÍπåÏßÄ ${remaining}Ï¥à`;

        const interval = setInterval(() => {
          remaining--;
          if (remaining > 0) {
            counter.innerText = `üì∏ ${
              photosTaken + 1
            }Î≤àÏß∏ Ï¥¨ÏòÅÍπåÏßÄ ${remaining}Ï¥à`;
          } else {
            clearInterval(interval);
            counter.innerText = `üì∏ ${photosTaken + 1}Î≤àÏß∏ Ï¥¨ÏòÅ Ï§ë...`;
            onFinish();
          }
        }, 1000);
      }

      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
          video.onloadedmetadata = () => {
            video.play();
          };
        })
        .catch((err) => {
          console.error("Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïã§Ìå®:", err);
          counter.innerText = "Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïã§Ìå®";
        });

      function takePhoto() {
        if (photosTaken >= 6) {
          counter.innerText = "Ï¥¨ÏòÅ ÏôÑÎ£å! Ï†ÄÏû• Ï§ë...";
          localStorage.setItem(
            "capturedPhotos",
            JSON.stringify(capturedPhotos)
          );
          continueBtn.classList.add("active");
          return;
        }

        flashEffect();

        const canvas = document.createElement("canvas");
        const targetRatio = 10 / 13;

        let canvasWidth, canvasHeight;
        if (video.videoWidth / video.videoHeight > targetRatio) {
          canvasHeight = video.videoHeight;
          canvasWidth = canvasHeight * targetRatio;
        } else {
          canvasWidth = video.videoWidth;
          canvasHeight = canvasWidth / targetRatio;
        }

        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        const ctx = canvas.getContext("2d");

        const sourceX = (video.videoWidth - canvasWidth) / 2;
        const sourceY = (video.videoHeight - canvasHeight) / 2;

        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(
          video,
          sourceX,
          sourceY,
          canvasWidth,
          canvasHeight,
          0,
          0,
          canvasWidth,
          canvasHeight
        );

        const dataURL = canvas.toDataURL("image/png");
        capturedPhotos.push(dataURL);

        const img = document.createElement("img");
        img.src = dataURL;
        photoDivs[photosTaken].innerHTML = "";
        photoDivs[photosTaken].appendChild(img);

        photosTaken++;

        if (photosTaken < 6) {
          startCountdown(8, takePhoto);
        } else {
          counter.innerText = "Ï¥¨ÏòÅ ÏôÑÎ£å! Ï†ÄÏû• Ï§ë...";
          localStorage.setItem(
            "capturedPhotos",
            JSON.stringify(capturedPhotos)
          );
          continueBtn.classList.add("active");
        }
      }

      // 5Ï¥à ÎåÄÍ∏∞ ÌõÑ ÏãúÏûë
      setTimeout(() => {
        startCountdown(8, takePhoto);

        const formData = new FormData();
        formData.append("frame", "{{ request.args.get('frame') }}");

        fetch("/api/session", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) throw new Error("ÏÑúÎ≤Ñ ÏùëÎãµ Ïã§Ìå®");
            return response.json();
          })
          .then((data) => {
            console.log("ÏÑúÎ≤Ñ ÏùëÎãµ:", data);
            localStorage.setItem("session", data.sessionID);
          })
          .catch((error) => {
            console.log("formData: ", formData.get("frame"));
            console.error("ÏóÖÎ°úÎìú Ïã§Ìå®:", error);
            alert("session ÏÉùÏÑ± Ï§ë Ïò§Î•ò Î∞úÏÉù.");
          });
      }, 5000);
    </script>
  </body>
</html>
